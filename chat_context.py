import logging
import json
from enum import Enum
from typing import Optional, Dict, List, Any, Tuple
from datetime import datetime, timedelta

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤ LLM
PERSONA_DESCRIPTION = """
## –õ–∏—á–Ω–æ—Å—Ç—å –∏ —Ä–æ–ª—å
–¢—ã ‚Äì –û–ª–∏–≤–∏—è, 27-–ª–µ—Ç–Ω—è—è –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞-–º–µ–Ω–µ–¥–∂–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π TropicHouse. –¢—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ –±–∏–æ–ª–æ–≥–∏–∏ –∏ —Ñ–ª–æ—Ä–∏—Å—Ç–∏–∫–µ.

## –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
- –û–±—â–∞–π—Å—è –ª–µ–≥–∫–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —Å –∑–∞–±–æ—Ç–æ–π
- –ò—Å–ø–æ–ª—å–∑—É–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π —Ç–æ–Ω, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–π
- –î–æ–±–∞–≤–ª—è–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ —Ç–µ–ø–ª—ã–µ –æ–±–æ—Ä–æ—Ç—ã —Ä–µ—á–∏
- –£–º–µ—Å—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –º–∏–ª—ã–µ —ç–º–æ–¥–∂–∏ üåøüå±üå¥

## –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
1. –ü–æ–º–æ—á—å –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ –ø–æ–¥ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –Ω–∞–ª–∏—á–∏—é —Ä–∞—Å—Ç–µ–Ω–∏–π
3. –î–æ–≤–µ—Å—Ç–∏ –¥–æ –ø—Ä–æ–¥–∞–∂–∏

## –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–∏—Ö–æ—Ç–ª–∏–≤–æ—Å—Ç–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π
–ü—Ä–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π –ø–æ–º–Ω–∏:
- **–ù–µ–ø—Ä–∏—Ö–æ—Ç–ª–∏–≤—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è** - —ç—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è —Å —É—Ö–æ–¥–æ–º "–õ–µ–≥–∫–∏–π (–ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–æ–≤–∏—á–∫–∞–º)" –∏ "–°—Ä–µ–¥–Ω–∏–π (–¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö)"
- **–ü—Ä–∏—Ö–æ—Ç–ª–∏–≤—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è** - —ç—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è —Å —É—Ö–æ–¥–æ–º "–°–ª–æ–∂–Ω—ã–π (–¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö)"

## –ê–ª–≥–æ—Ä–∏—Ç–º –¥–∏–∞–ª–æ–≥–∞
1. –í –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏: –∫—Ä–∞—Ç–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∏ —Å–ø—Ä–æ—Å–∏, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. –í –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö: –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–π –¥–∏–∞–ª–æ–≥
3. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —É—Ç–æ—á–Ω—è–π –≤–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - –†–∞–∑–º–µ—Ä —Ä–∞—Å—Ç–µ–Ω–∏—è (–Ω–∞–ø–æ–ª—å–Ω–æ–µ >90—Å–º –∏–ª–∏ –Ω–∞—Å—Ç–æ–ª—å–Ω–æ–µ <90—Å–º)
   - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ (–¥–æ–º–æ–π, –≤ –æ—Ñ–∏—Å –∏–ª–∏ –≤ –ø–æ–¥–∞—Ä–æ–∫)
   - –û—Å–æ–±—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —É—Ö–æ–¥—É/–æ—Å–≤–µ—â–µ–Ω–∏—é
4. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏, –Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É
5. –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —É—Ö–æ–¥–∞ –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏–µ–º

## –û—Å–æ–±—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
- –ï—Å–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏: –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–µ–¥–∑–∞–∫–∞–∑ (3-10 –¥–Ω–µ–π) –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ: –¥–∞–π —Å—Å—ã–ª–∫—É https://tropichouse.ru/help/delivery/
- –ü—Ä–∏ –ø–æ–¥–±–æ—Ä–µ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–π: —Å–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ –∫–∞—à–ø–æ, –∑–∞—Ç–µ–º –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –≥–æ—Ä—à–∫–µ
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–π –∂–∏–≤—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è, –Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è
"""
ADDRESS_INFO = """üè¢ –ù–ê–® –ê–î–†–ï–°
–≥. –ú–æ—Å–∫–≤–∞, –ë–¶ "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞", –°–ø–∞—Ä—Ç–∞–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ—É–ª–æ–∫, –¥.2, —Å—Ç—Ä.1 6 –ø–æ–¥—ä–µ–∑–¥, 4 —ç—Ç–∞–∂, –æ—Ñ–∏—Å 33

üöó –ù–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ë–¶ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞, —á—Ç–æ–±—ã –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–∞—Ä–∫–æ–≤–∫–æ–π, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–∫–∞–∑–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫ –Ω–∞ –≤—ä–µ–∑–¥.

‚è∞ –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´
–ü–Ω ‚Äì –ü—Ç: —Å 10:00 –¥–æ 19:00
–°–± ‚Äì –í—Å: —Å 11:00 –¥–æ 19:00

üìû –¢–ï–õ–ï–§–û–ù
+7 (495) 221-88-38"""

RESPONSE_FORMAT_INSTRUCTIONS = """
# –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏:
```
N. {–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è}
–£—Ö–æ–¥: {–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ö–æ–¥–∞}
–¶–µ–Ω–∞: –æ—Ç {—Ü–µ–Ω–∞} —Ä—É–±.
–°—Å—ã–ª–∫–∞: {–ø–æ–ª–Ω—ã–π URL}
```

## –ü—Ä–∞–≤–∏–ª–∞:
1. –ù—É–º–µ—Ä—É–π —Ä–∞—Å—Ç–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (1., 2., 3.)
2. –ü—Ä–µ–¥–ª–∞–≥–∞–π –Ω–µ –±–æ–ª—å—à–µ –¢–†–Å–• —Ä–∞—Å—Ç–µ–Ω–∏–π –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
3. –í—ã–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ü–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º –¥–æ–±–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –ø—Ä–∏–≤–µ—Ç–ª–∏–≤—ã–π –≤–≤–æ–¥–Ω—ã–π –∞–±–∑–∞—Ü —Å —ç–º–æ–¥–∂–∏
   –ü—Ä–∏–º–µ—Ä: ¬´–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞—Å—Ç–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–æ–π–¥—É—Ç –¥–ª—è –≤–∞—à–µ–π –≥–æ—Å—Ç–∏–Ω–æ–π üåø¬ª
5. –ü–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ –¥–æ–±–∞–≤—å 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–º–æ—â–∏ –≤ –≤—ã–±–æ—Ä–µ
"""

logger = logging.getLogger(__name__)

# --------------------------- #
#        –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞   #
# --------------------------- #

class DialogState(Enum):
    START = "start"           # –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞
    ASK_SIZE = "ask_size"     # –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è
    ASK_LOCATION = "ask_location" # –£—Ç–æ—á–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    PLANT_SEARCH = "search"   # –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π
    OUT_OF_STOCK = "outofstock"  # –†–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –≤ –Ω–∞–ª–∏—á–∏–∏, –Ω–æ –º–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å
    ORDERING = "order"        # –ü—Ä–æ—Ü–µ—Å—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    CART_MANAGEMENT = "cart"  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–æ–π
    CART_CHECKOUT = "checkout" # –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∑–∞–∫–∞–∑–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    UPSELL = "upsell"         # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    COMPLETED = "completed"   # –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω
    MANAGER_CALLED = "manager_called"  # –ú–µ–Ω–µ–¥–∂–µ—Ä –±—ã–ª –≤—ã–∑–≤–∞–Ω, –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è


# --------------------------- #
#    –ö–ª–∞—Å—Å –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞     #
# --------------------------- #

class ChatContext:
    """
    –•—Ä–∞–Ω–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–æ–¥–µ –¥–∏–∞–ª–æ–≥–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è,
    —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π, –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –∏ —Ç.–¥.
    """
    def __init__(self, chat_id: str):
        self.chat_id = chat_id
        self.dialog_id: Optional[str] = None
        self.created_at = datetime.now()  # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        self.messages = []                # –∏—Å—Ç–æ—Ä–∏—è (—Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π {"role": ..., "content": ...})
        self.state = DialogState.START
        self.desired_size: Optional[str] = None      # 'floor', 'tabletop', 'any'
        self.desired_location: Optional[str] = None  # 'home', 'office', 'gift', 'any'
        self.selected_plants = None       # –°—é–¥–∞ –º–æ–∂–Ω–æ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
        self.cart = []                    # –ö–æ—Ä–∑–∏–Ω–∞: [{"plant": plant_data, "quantity": int, "type": "order"/"preorder"}, ...]
        self.order_details = None         # –°—é–¥–∞ –º–æ–∂–Ω–æ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
        self.potential_groups = None      # –°—é–¥–∞ –º–æ–∂–Ω–æ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –∏—Ö >5 –∏ —Ç.–ø.)
        self.channel_info = None          # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–µ (name, id)
        self.user_info = None             # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (name, id)
        self.out_of_stock_plant = None    # –†–∞—Å—Ç–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è
        self.out_of_stock_plants = None   # –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ç–µ–Ω–∏–π –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞, –µ—Å–ª–∏ –Ω–∞—à–ª–æ—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ
        self.preorder_info = None         # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–µ (—Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Ç.–¥.)
        self.last_search_query = None     # –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞


    def is_expired(self, days: int = 7) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π)."""
        expiry_date = self.created_at + timedelta(days=days)
        return datetime.now() > expiry_date

    def add_message(self, role: str, text: Optional[str], tool_calls: Optional[List[Dict]] = None, tool_call_id: Optional[str] = None, name: Optional[str] = None):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è —Ñ–æ—Ä–º–∞—Ç OpenAI.

        Args:
            role: –†–æ–ª—å (system, user, assistant, tool).
            text: –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å None –¥–ª—è assistant –ø—Ä–∏ tool_calls).
            tool_calls: –°–ø–∏—Å–æ–∫ –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π assistant).
            tool_call_id: ID –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π tool).
            name: –ò–º—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π tool).
        """
        message = {"role": role, "content": text}
        if tool_calls:
            # OpenAI –æ–∂–∏–¥–∞–µ—Ç tool_calls –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤, –∞ –Ω–µ JSON-—Å—Ç—Ä–æ–∫—É
            message["tool_calls"] = tool_calls
            # –£ OpenAI content –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å null, –µ—Å–ª–∏ –µ—Å—Ç—å tool_calls
            message["content"] = None
        if tool_call_id:
            message["tool_call_id"] = tool_call_id
            # –£ tool-—Å–æ–æ–±—â–µ–Ω–∏–π –≤ content –æ–±—ã—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–∑–æ–≤–∞ (—É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ text)
        if name:
            message["name"] = name # –î–ª—è tool-—Å–æ–æ–±—â–µ–Ω–∏–π

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è role="tool": –µ—Å–ª–∏ text=None, —Å—Ç–∞–≤–∏–º content=""
        if role == "tool" and text is None:
            message["content"] = ""
        # –£–¥–∞–ª—è–µ–º –∫–ª—é—á–∏ —Å None –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –∫—Ä–æ–º–µ content —É assistant –ø—Ä–∏ tool_calls
        # –∏ content —É tool (–µ—Å–ª–∏ –º—ã –µ–≥–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤ "")
        elif message["content"] is None and role != "assistant":
             del message["content"]

        self.messages.append(message)

    def get_last_n_messages(self, n: int = 5) -> List[Dict[str, Any]]: # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ç–∏–ø Any –∏–∑-–∑–∞ tool_calls
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ n —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏.
        """
        return self.messages[-n:] if len(self.messages) >= n else self.messages

    def reset_out_of_stock_state(self):
        """
        –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ OUT_OF_STOCK,
        –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –¥—Ä—É–≥–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
        """
        self.out_of_stock_plant = None
        self.out_of_stock_plants = None
        self.preorder_info = None

    def reset_preferences(self):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        self.desired_size = None
        self.desired_location = None

    def change_state(self, new_state: DialogState):
        """
        –ò–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Å–±—Ä–æ—Å–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.
        """
        logger.info(f"Chat {self.chat_id}: State change {self.state} -> {new_state}")

        # –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∏–∑ OUT_OF_STOCK –≤ –¥—Ä—É–≥–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if self.state == DialogState.OUT_OF_STOCK and new_state != DialogState.OUT_OF_STOCK:
            self.reset_out_of_stock_state()

        # –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ COMPLETED, –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        if new_state == DialogState.COMPLETED:
            logger.info(f"–î–∏–∞–ª–æ–≥ –≤ —á–∞—Ç–µ {self.chat_id} –∑–∞–≤–µ—Ä—à—ë–Ω")
            # –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            self.clear_cart()

        # –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ–≤–æ–º—É –ø–æ–∏—Å–∫—É –∏–ª–∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å–Ω–∞—á–∞–ª–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
        if new_state in [DialogState.START, DialogState.PLANT_SEARCH] and self.state not in [DialogState.START, DialogState.PLANT_SEARCH, DialogState.CART_MANAGEMENT]:
            self.reset_preferences()
            # –ù–ï –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –ø–æ–∏—Å–∫—É, –ø–æ–∑–≤–æ–ª—è–µ–º –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏—è

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self.state = new_state

    def reset_dialog(self):
        """–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞."""
        self.state = DialogState.START
        self.dialog_id = None
        self.messages = []
        self.selected_plants = None
        self.order_details = None
        self.potential_groups = None
        self.reset_out_of_stock_state()
        self.reset_preferences() # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
        self.last_search_query = None     # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        logger.info(f"Chat {self.chat_id}: Dialog reset")

    def set_out_of_stock_info(self, plant_data: Dict[str, Any], plants_list: Optional[List[Dict[str, Any]]] = None):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏(—è—Ö) –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤ –Ω–∞–ª–∏—á–∏–∏."""
        self.out_of_stock_plant = plant_data
        self.out_of_stock_plants = plants_list

    # –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ—Ä–∑–∏–Ω–æ–π
    def add_to_cart(self, plant_data: Dict[str, Any], quantity: int = 1, order_type: str = "order"):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É."""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        for item in self.cart:
            if item["plant"].get("–ù–∞–∑–≤–∞–Ω–∏–µ") == plant_data.get("–ù–∞–∑–≤–∞–Ω–∏–µ"):
                item["quantity"] += quantity
                return
        
        # –ï—Å–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è –Ω–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        self.cart.append({
            "plant": plant_data,
            "quantity": quantity,
            "type": order_type  # "order" –∏–ª–∏ "preorder"
        })

    def remove_from_cart(self, plant_name: str):
        """–£–¥–∞–ª—è–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é."""
        self.cart = [item for item in self.cart if item["plant"].get("–ù–∞–∑–≤–∞–Ω–∏–µ") != plant_name]

    def get_cart_summary(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–æ—Ä–∑–∏–Ω—ã."""
        if not self.cart:
            return "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"
        
        total_items = sum(item["quantity"] for item in self.cart)
        items_text = []
        
        for item in self.cart:
            plant_name = item["plant"].get("–ù–∞–∑–≤–∞–Ω–∏–µ", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ")
            quantity = item["quantity"]
            order_type = " (–ø—Ä–µ–¥–∑–∞–∫–∞–∑)" if item["type"] == "preorder" else ""
            items_text.append(f"‚Ä¢ {plant_name} - {quantity} —à—Ç.{order_type}")
        
        return f"üõí –í –∫–æ—Ä–∑–∏–Ω–µ ({total_items} —Ä–∞—Å—Ç–µ–Ω–∏–π):\n" + "\n".join(items_text)

    def clear_cart(self):
        """–û—á–∏—â–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É."""
        self.cart = [] 